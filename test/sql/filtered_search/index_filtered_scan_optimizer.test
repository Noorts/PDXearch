# name: test/sql/filtered_search/index_filtered_scan_optimizer.test
# description: Optimizer takes predicate type into account when optimizing plan. See documentation in the index scan optimizer for more information about the specific scenarios.
# group: [filtered_search]

require parquet

require pdxearch

# Variables
test-env INDEX_SEED 0

test-env DIMS 128

test-env NUM_ROWS 20000

test-env QUERY_EMB [0,16,35,5,32,31,14,10,11,78,55,10,45,83,11,6,14,57,102,75,20,8,3,5,67,17,19,26,5,0,1,22,60,26,7,1,18,22,84,53,85,119,119,4,24,18,7,7,1,81,106,102,72,30,6,0,9,1,9,119,72,1,4,33,119,29,6,1,0,1,14,52,119,30,3,0,0,55,92,111,2,5,4,9,22,89,96,14,1,0,1,82,59,16,20,5,25,14,11,4,0,0,1,26,47,23,4,0,0,4,38,83,30,14,9,4,9,17,23,41,0,0,2,8,19,25,23,1]

# Set up the table and rows.
statement ok
CREATE TABLE t1 (id INTEGER, emb FLOAT[${DIMS}]);

statement ok
INSERT INTO t1 FROM read_parquet('test/assets/sift-128-euclidean-245760.parquet') LIMIT ${NUM_ROWS};

foreach distance_func array_distance

# ============================================
# Filtered PDXearch index scan is not used if there is no index.
# ============================================

query II
EXPLAIN SELECT * FROM t1 WHERE id > 1000 ORDER BY ${distance_func}(emb, ${QUERY_EMB}::FLOAT[${DIMS}]) LIMIT 50;
----
physical_plan	<!REGEX>:.*PDXEARCH_INDEX_FILT_SCAN.*

endloop

# ============================================
# Filtered PDXearch index scan + sequential scan (with pushed down filters) is
# used for simple filters.
# ============================================

# TODO: Investigate. Should this be required? See the HASH_JOIN check below.
statement ok
SET late_materialization_max_rows = 0;

statement ok
CREATE INDEX t1_idx ON t1 USING PDXEARCH (emb) WITH (seed = ${INDEX_SEED});

foreach distance_func array_distance

query II
EXPLAIN SELECT * FROM t1 WHERE id > 1000 ORDER BY ${distance_func}(emb, ${QUERY_EMB}::FLOAT[${DIMS}]) LIMIT 50;
----
physical_plan	<REGEX>:.*PDXEARCH_INDEX_FILT_SCAN.*SEQ_SCAN.*Filters.*

query II
EXPLAIN SELECT * FROM t1 WHERE id > 1000 ORDER BY ${distance_func}(emb, ${QUERY_EMB}::FLOAT[${DIMS}]) LIMIT 50;
----
physical_plan	<!REGEX>:.*HASH_JOIN.*

# ============================================
# Optimizer correctly handles the projected columns for simple filtered search.
# The projection is correctly moved to the index filtered scan.
# ============================================

# id
query II
EXPLAIN SELECT id FROM t1 WHERE id > 1000 ORDER BY ${distance_func}(emb, ${QUERY_EMB}::FLOAT[${DIMS}]) LIMIT 5;
----
physical_plan	<REGEX>:.*PDXEARCH_INDEX_FILT_SCAN.*

query I rowsort
SELECT id FROM t1 WHERE id > 1000 ORDER BY ${distance_func}(emb, ${QUERY_EMB}::FLOAT[${DIMS}]) LIMIT 5;
----
10336
10686
11511
12386
17359

# emb
query II
EXPLAIN SELECT emb FROM t1 WHERE id > 1000 ORDER BY ${distance_func}(emb, ${QUERY_EMB}::FLOAT[${DIMS}]) LIMIT 5;
----
physical_plan	<REGEX>:.*PDXEARCH_INDEX_FILT_SCAN.*

query I rowsort
SELECT emb FROM t1 WHERE id > 1000 ORDER BY ${distance_func}(emb, ${QUERY_EMB}::FLOAT[${DIMS}]) LIMIT 5;
----
[0.0, 0.0, 4.0, 8.0, 40.0, 40.0, 3.0, 0.0, 85.0, 36.0, 15.0, 9.0, 35.0, 37.0, 14.0, 9.0, 55.0, 92.0, 95.0, 23.0, 21.0, 17.0, 1.0, 5.0, 31.0, 11.0, 28.0, 21.0, 31.0, 24.0, 7.0, 21.0, 40.0, 26.0, 16.0, 4.0, 21.0, 39.0, 48.0, 17.0, 67.0, 119.0, 119.0, 6.0, 17.0, 8.0, 0.0, 9.0, 25.0, 119.0, 73.0, 56.0, 42.0, 17.0, 1.0, 2.0, 21.0, 0.0, 13.0, 119.0, 73.0, 17.0, 7.0, 15.0, 119.0, 16.0, 0.0, 0.0, 2.0, 4.0, 40.0, 77.0, 79.0, 55.0, 23.0, 0.0, 0.0, 8.0, 119.0, 119.0, 16.0, 17.0, 14.0, 6.0, 24.0, 65.0, 119.0, 61.0, 0.0, 11.0, 12.0, 28.0, 97.0, 63.0, 7.0, 0.0, 31.0, 26.0, 13.0, 3.0, 0.0, 5.0, 26.0, 27.0, 48.0, 52.0, 28.0, 3.0, 6.0, 9.0, 70.0, 53.0, 78.0, 5.0, 3.0, 3.0, 5.0, 8.0, 30.0, 87.0, 4.0, 19.0, 18.0, 4.0, 10.0, 14.0, 5.0, 5.0]
[0.0, 1.0, 40.0, 48.0, 23.0, 14.0, 6.0, 3.0, 38.0, 118.0, 84.0, 36.0, 28.0, 30.0, 8.0, 3.0, 11.0, 85.0, 118.0, 66.0, 25.0, 2.0, 0.0, 0.0, 36.0, 70.0, 24.0, 26.0, 28.0, 7.0, 0.0, 1.0, 39.0, 36.0, 33.0, 36.0, 14.0, 5.0, 89.0, 58.0, 77.0, 118.0, 113.0, 27.0, 8.0, 0.0, 3.0, 18.0, 13.0, 83.0, 59.0, 118.0, 99.0, 7.0, 1.0, 1.0, 29.0, 32.0, 48.0, 73.0, 49.0, 7.0, 8.0, 22.0, 114.0, 10.0, 19.0, 0.0, 0.0, 3.0, 20.0, 56.0, 118.0, 34.0, 5.0, 0.0, 0.0, 3.0, 50.0, 117.0, 10.0, 14.0, 17.0, 25.0, 47.0, 56.0, 78.0, 24.0, 8.0, 7.0, 64.0, 56.0, 40.0, 15.0, 17.0, 13.0, 43.0, 14.0, 3.0, 3.0, 0.0, 1.0, 7.0, 20.0, 98.0, 20.0, 5.0, 0.0, 0.0, 3.0, 16.0, 92.0, 10.0, 8.0, 11.0, 11.0, 9.0, 22.0, 29.0, 19.0, 13.0, 9.0, 10.0, 10.0, 15.0, 17.0, 30.0, 22.0]
[0.0, 8.0, 45.0, 53.0, 39.0, 13.0, 10.0, 4.0, 31.0, 117.0, 97.0, 41.0, 26.0, 15.0, 18.0, 1.0, 8.0, 62.0, 117.0, 66.0, 26.0, 2.0, 0.0, 0.0, 23.0, 71.0, 35.0, 18.0, 26.0, 6.0, 0.0, 0.0, 54.0, 42.0, 44.0, 39.0, 28.0, 1.0, 62.0, 86.0, 54.0, 117.0, 117.0, 23.0, 10.0, 0.0, 0.0, 8.0, 8.0, 53.0, 78.0, 117.0, 117.0, 5.0, 0.0, 0.0, 52.0, 44.0, 43.0, 51.0, 38.0, 8.0, 7.0, 19.0, 117.0, 12.0, 5.0, 2.0, 0.0, 0.0, 8.0, 71.0, 117.0, 38.0, 11.0, 1.0, 2.0, 9.0, 63.0, 94.0, 8.0, 12.0, 26.0, 44.0, 71.0, 64.0, 52.0, 24.0, 9.0, 10.0, 58.0, 72.0, 32.0, 13.0, 8.0, 15.0, 60.0, 16.0, 7.0, 0.0, 0.0, 0.0, 1.0, 35.0, 62.0, 17.0, 5.0, 0.0, 0.0, 8.0, 18.0, 84.0, 8.0, 7.0, 12.0, 13.0, 16.0, 25.0, 31.0, 30.0, 11.0, 6.0, 16.0, 7.0, 20.0, 19.0, 20.0, 23.0]
[12.0, 19.0, 17.0, 3.0, 0.0, 0.0, 2.0, 24.0, 4.0, 35.0, 56.0, 14.0, 16.0, 33.0, 7.0, 14.0, 0.0, 40.0, 86.0, 40.0, 15.0, 8.0, 1.0, 0.0, 47.0, 2.0, 4.0, 22.0, 18.0, 7.0, 7.0, 5.0, 58.0, 38.0, 20.0, 3.0, 0.0, 1.0, 3.0, 29.0, 74.0, 112.0, 112.0, 9.0, 4.0, 9.0, 13.0, 10.0, 1.0, 46.0, 101.0, 112.0, 112.0, 15.0, 16.0, 1.0, 102.0, 25.0, 3.0, 112.0, 69.0, 1.0, 0.0, 0.0, 110.0, 4.0, 0.0, 0.0, 0.0, 2.0, 6.0, 112.0, 112.0, 25.0, 0.0, 0.0, 6.0, 36.0, 58.0, 104.0, 7.0, 2.0, 0.0, 32.0, 45.0, 112.0, 112.0, 22.0, 53.0, 32.0, 22.0, 75.0, 23.0, 3.0, 20.0, 24.0, 26.0, 7.0, 11.0, 0.0, 0.0, 0.0, 2.0, 66.0, 28.0, 7.0, 3.0, 0.0, 4.0, 26.0, 56.0, 112.0, 15.0, 1.0, 0.0, 2.0, 21.0, 80.0, 52.0, 29.0, 22.0, 3.0, 2.0, 0.0, 0.0, 1.0, 55.0, 60.0]
[9.0, 2.0, 4.0, 2.0, 8.0, 21.0, 34.0, 34.0, 3.0, 10.0, 61.0, 22.0, 49.0, 53.0, 15.0, 10.0, 12.0, 77.0, 90.0, 29.0, 11.0, 8.0, 7.0, 6.0, 24.0, 19.0, 38.0, 52.0, 14.0, 0.0, 0.0, 6.0, 121.0, 15.0, 5.0, 2.0, 4.0, 6.0, 13.0, 58.0, 121.0, 91.0, 121.0, 24.0, 5.0, 1.0, 0.0, 15.0, 2.0, 84.0, 121.0, 47.0, 58.0, 32.0, 0.0, 0.0, 20.0, 21.0, 23.0, 68.0, 109.0, 20.0, 0.0, 10.0, 121.0, 19.0, 1.0, 3.0, 7.0, 2.0, 3.0, 52.0, 121.0, 21.0, 2.0, 2.0, 2.0, 17.0, 96.0, 121.0, 3.0, 1.0, 3.0, 6.0, 52.0, 121.0, 74.0, 11.0, 21.0, 8.0, 3.0, 6.0, 35.0, 93.0, 25.0, 30.0, 24.0, 18.0, 2.0, 0.0, 2.0, 2.0, 6.0, 44.0, 32.0, 36.0, 9.0, 3.0, 0.0, 1.0, 76.0, 79.0, 1.0, 3.0, 4.0, 20.0, 18.0, 50.0, 84.0, 12.0, 0.0, 0.0, 0.0, 16.0, 15.0, 23.0, 15.0, 15.0]

# *
query II
EXPLAIN SELECT * FROM t1 WHERE id > 1000 ORDER BY ${distance_func}(emb, ${QUERY_EMB}::FLOAT[${DIMS}]) LIMIT 5;
----
physical_plan	<REGEX>:.*PDXEARCH_INDEX_FILT_SCAN.*

query II rowsort
SELECT * FROM t1 WHERE id > 1000 ORDER BY ${distance_func}(emb, ${QUERY_EMB}::FLOAT[${DIMS}]) LIMIT 5;
----
10336	[0.0, 1.0, 40.0, 48.0, 23.0, 14.0, 6.0, 3.0, 38.0, 118.0, 84.0, 36.0, 28.0, 30.0, 8.0, 3.0, 11.0, 85.0, 118.0, 66.0, 25.0, 2.0, 0.0, 0.0, 36.0, 70.0, 24.0, 26.0, 28.0, 7.0, 0.0, 1.0, 39.0, 36.0, 33.0, 36.0, 14.0, 5.0, 89.0, 58.0, 77.0, 118.0, 113.0, 27.0, 8.0, 0.0, 3.0, 18.0, 13.0, 83.0, 59.0, 118.0, 99.0, 7.0, 1.0, 1.0, 29.0, 32.0, 48.0, 73.0, 49.0, 7.0, 8.0, 22.0, 114.0, 10.0, 19.0, 0.0, 0.0, 3.0, 20.0, 56.0, 118.0, 34.0, 5.0, 0.0, 0.0, 3.0, 50.0, 117.0, 10.0, 14.0, 17.0, 25.0, 47.0, 56.0, 78.0, 24.0, 8.0, 7.0, 64.0, 56.0, 40.0, 15.0, 17.0, 13.0, 43.0, 14.0, 3.0, 3.0, 0.0, 1.0, 7.0, 20.0, 98.0, 20.0, 5.0, 0.0, 0.0, 3.0, 16.0, 92.0, 10.0, 8.0, 11.0, 11.0, 9.0, 22.0, 29.0, 19.0, 13.0, 9.0, 10.0, 10.0, 15.0, 17.0, 30.0, 22.0]
10686	[0.0, 8.0, 45.0, 53.0, 39.0, 13.0, 10.0, 4.0, 31.0, 117.0, 97.0, 41.0, 26.0, 15.0, 18.0, 1.0, 8.0, 62.0, 117.0, 66.0, 26.0, 2.0, 0.0, 0.0, 23.0, 71.0, 35.0, 18.0, 26.0, 6.0, 0.0, 0.0, 54.0, 42.0, 44.0, 39.0, 28.0, 1.0, 62.0, 86.0, 54.0, 117.0, 117.0, 23.0, 10.0, 0.0, 0.0, 8.0, 8.0, 53.0, 78.0, 117.0, 117.0, 5.0, 0.0, 0.0, 52.0, 44.0, 43.0, 51.0, 38.0, 8.0, 7.0, 19.0, 117.0, 12.0, 5.0, 2.0, 0.0, 0.0, 8.0, 71.0, 117.0, 38.0, 11.0, 1.0, 2.0, 9.0, 63.0, 94.0, 8.0, 12.0, 26.0, 44.0, 71.0, 64.0, 52.0, 24.0, 9.0, 10.0, 58.0, 72.0, 32.0, 13.0, 8.0, 15.0, 60.0, 16.0, 7.0, 0.0, 0.0, 0.0, 1.0, 35.0, 62.0, 17.0, 5.0, 0.0, 0.0, 8.0, 18.0, 84.0, 8.0, 7.0, 12.0, 13.0, 16.0, 25.0, 31.0, 30.0, 11.0, 6.0, 16.0, 7.0, 20.0, 19.0, 20.0, 23.0]
11511	[9.0, 2.0, 4.0, 2.0, 8.0, 21.0, 34.0, 34.0, 3.0, 10.0, 61.0, 22.0, 49.0, 53.0, 15.0, 10.0, 12.0, 77.0, 90.0, 29.0, 11.0, 8.0, 7.0, 6.0, 24.0, 19.0, 38.0, 52.0, 14.0, 0.0, 0.0, 6.0, 121.0, 15.0, 5.0, 2.0, 4.0, 6.0, 13.0, 58.0, 121.0, 91.0, 121.0, 24.0, 5.0, 1.0, 0.0, 15.0, 2.0, 84.0, 121.0, 47.0, 58.0, 32.0, 0.0, 0.0, 20.0, 21.0, 23.0, 68.0, 109.0, 20.0, 0.0, 10.0, 121.0, 19.0, 1.0, 3.0, 7.0, 2.0, 3.0, 52.0, 121.0, 21.0, 2.0, 2.0, 2.0, 17.0, 96.0, 121.0, 3.0, 1.0, 3.0, 6.0, 52.0, 121.0, 74.0, 11.0, 21.0, 8.0, 3.0, 6.0, 35.0, 93.0, 25.0, 30.0, 24.0, 18.0, 2.0, 0.0, 2.0, 2.0, 6.0, 44.0, 32.0, 36.0, 9.0, 3.0, 0.0, 1.0, 76.0, 79.0, 1.0, 3.0, 4.0, 20.0, 18.0, 50.0, 84.0, 12.0, 0.0, 0.0, 0.0, 16.0, 15.0, 23.0, 15.0, 15.0]
12386	[12.0, 19.0, 17.0, 3.0, 0.0, 0.0, 2.0, 24.0, 4.0, 35.0, 56.0, 14.0, 16.0, 33.0, 7.0, 14.0, 0.0, 40.0, 86.0, 40.0, 15.0, 8.0, 1.0, 0.0, 47.0, 2.0, 4.0, 22.0, 18.0, 7.0, 7.0, 5.0, 58.0, 38.0, 20.0, 3.0, 0.0, 1.0, 3.0, 29.0, 74.0, 112.0, 112.0, 9.0, 4.0, 9.0, 13.0, 10.0, 1.0, 46.0, 101.0, 112.0, 112.0, 15.0, 16.0, 1.0, 102.0, 25.0, 3.0, 112.0, 69.0, 1.0, 0.0, 0.0, 110.0, 4.0, 0.0, 0.0, 0.0, 2.0, 6.0, 112.0, 112.0, 25.0, 0.0, 0.0, 6.0, 36.0, 58.0, 104.0, 7.0, 2.0, 0.0, 32.0, 45.0, 112.0, 112.0, 22.0, 53.0, 32.0, 22.0, 75.0, 23.0, 3.0, 20.0, 24.0, 26.0, 7.0, 11.0, 0.0, 0.0, 0.0, 2.0, 66.0, 28.0, 7.0, 3.0, 0.0, 4.0, 26.0, 56.0, 112.0, 15.0, 1.0, 0.0, 2.0, 21.0, 80.0, 52.0, 29.0, 22.0, 3.0, 2.0, 0.0, 0.0, 1.0, 55.0, 60.0]
17359	[0.0, 0.0, 4.0, 8.0, 40.0, 40.0, 3.0, 0.0, 85.0, 36.0, 15.0, 9.0, 35.0, 37.0, 14.0, 9.0, 55.0, 92.0, 95.0, 23.0, 21.0, 17.0, 1.0, 5.0, 31.0, 11.0, 28.0, 21.0, 31.0, 24.0, 7.0, 21.0, 40.0, 26.0, 16.0, 4.0, 21.0, 39.0, 48.0, 17.0, 67.0, 119.0, 119.0, 6.0, 17.0, 8.0, 0.0, 9.0, 25.0, 119.0, 73.0, 56.0, 42.0, 17.0, 1.0, 2.0, 21.0, 0.0, 13.0, 119.0, 73.0, 17.0, 7.0, 15.0, 119.0, 16.0, 0.0, 0.0, 2.0, 4.0, 40.0, 77.0, 79.0, 55.0, 23.0, 0.0, 0.0, 8.0, 119.0, 119.0, 16.0, 17.0, 14.0, 6.0, 24.0, 65.0, 119.0, 61.0, 0.0, 11.0, 12.0, 28.0, 97.0, 63.0, 7.0, 0.0, 31.0, 26.0, 13.0, 3.0, 0.0, 5.0, 26.0, 27.0, 48.0, 52.0, 28.0, 3.0, 6.0, 9.0, 70.0, 53.0, 78.0, 5.0, 3.0, 3.0, 5.0, 8.0, 30.0, 87.0, 4.0, 19.0, 18.0, 4.0, 10.0, 14.0, 5.0, 5.0]

# rowid
query II
EXPLAIN SELECT rowid FROM t1 WHERE id > 1000 ORDER BY ${distance_func}(emb, ${QUERY_EMB}::FLOAT[${DIMS}]) LIMIT 5;
----
physical_plan	<REGEX>:.*PDXEARCH_INDEX_FILT_SCAN.*

query I rowsort
SELECT rowid FROM t1 WHERE id > 1000 ORDER BY ${distance_func}(emb, ${QUERY_EMB}::FLOAT[${DIMS}]) LIMIT 5;
----
10336
10686
11511
12386
17359

# array_distance
query II
EXPLAIN SELECT array_distance(emb, ${QUERY_EMB}::FLOAT[${DIMS}]) FROM t1 WHERE id > 1000 ORDER BY ${distance_func}(emb, ${QUERY_EMB}::FLOAT[${DIMS}]) LIMIT 5;
----
physical_plan	<REGEX>:.*PDXEARCH_INDEX_FILT_SCAN.*

query I rowsort
SELECT array_distance(emb, ${QUERY_EMB}::FLOAT[${DIMS}]) FROM t1 WHERE id > 1000 ORDER BY ${distance_func}(emb, ${QUERY_EMB}::FLOAT[${DIMS}]) LIMIT 5;
----
218.88124
245.28758
246.9676
252.75284
252.78053

# TODO: Re-enable. Initial idea is that this has to do with the PDXearch WHERE id=1 bug.
# rowid (with rowid in pushed down filter)
# query II
# EXPLAIN SELECT rowid FROM t1 WHERE id > 1000 AND rowid > 1 ORDER BY ${distance_func}(emb, ${QUERY_EMB}::FLOAT[${DIMS}]) LIMIT 5;
# ----
# physical_plan	<REGEX>:.*PDXEARCH_INDEX_FILT_SCAN.*

# query I rowsort
# SELECT rowid FROM t1 WHERE id > 1000 AND rowid > 1 ORDER BY ${distance_func}(emb, ${QUERY_EMB}::FLOAT[${DIMS}]) LIMIT 5;
# ----
# 1000
# 1001
# 1002
# 1003
# 1004

# TODO: Enable once the complex filter optimization is implemented and update
#       the tests to verify that the test logic is as tight as possible. Clean
#       up syntax. Perhaps DSL for physical plan. Perhaps example in DuckDB
#       tests. Consider verifying projections at filter and seq scan levels.

# ============================================
# Filtered PDXearch index scan + filter + sequential scan (with no filters) is
# used for composite filters.
# ============================================

# query II
# EXPLAIN SELECT * FROM t1 WHERE id > 1000 OR emb = ${QUERY_EMB}::FLOAT[${DIMS}] ORDER BY ${distance_func}(emb, ${QUERY_EMB}::FLOAT[${DIMS}]) LIMIT 50;
# ----
# physical_plan	<REGEX>:.*PDXEARCH_INDEX_FILT_SCAN.*FILTER.*SEQ_SCAN.*

# query II
# EXPLAIN SELECT * FROM t1 WHERE id > 1000 OR emb = ${QUERY_EMB}::FLOAT[${DIMS}] ORDER BY ${distance_func}(emb, ${QUERY_EMB}::FLOAT[${DIMS}]) LIMIT 50;
# ----
# physical_plan	<!REGEX>:.*SEQ_SCAN.*Filters.*

# ============================================
# Filtered PDXearch index scan + filter + sequential scan (with pushed down
# filters) is used for simple + composite filters.
# ============================================

# query II
# EXPLAIN SELECT * FROM t1 WHERE id > 1500 AND (id > 1000 OR emb = ${QUERY_EMB}::FLOAT[${DIMS}]) ORDER BY ${distance_func}(emb, ${QUERY_EMB}::FLOAT[${DIMS}]) LIMIT 50;
# ----
# physical_plan	<REGEX>:.*PDXEARCH_INDEX_FILT_SCAN.*FILTER.*SEQ_SCAN.*Filters.*



endloop