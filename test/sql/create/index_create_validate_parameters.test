# name: test/sql/create/index_create_validate_parameters.test
# description: Validate the parameters passed during index creation.
# group: [create]

require parquet

require pdxearch

statement ok
CREATE TABLE t1 (id INTEGER, emb FLOAT[128]);

statement ok
INSERT INTO t1 FROM read_parquet('test/assets/sift-128-euclidean-245760.parquet') LIMIT 100;

# ============================================
# Combination of parameters
# ============================================

statement ok
CREATE INDEX idx ON t1 USING PDXEARCH (emb) WITH (metric = 'l2sq', quantization = 'f32', n_probe = 128, normalize = 0, seed = 0);

statement ok
DROP INDEX IF EXISTS idx;

# ============================================
# Parameter: metric
# ============================================

statement error
CREATE INDEX idx ON t1 USING PDXEARCH (emb) WITH (metric = 1);
----
Binder Error: PDXearch index 'metric' must be a string

statement error
CREATE INDEX idx ON t1 USING PDXEARCH (emb) WITH (metric = 'test');
----
Binder Error: PDXearch index 'metric' must be one of: 'l2sq'

foreach metric l2sq

statement ok
CREATE INDEX idx ON t1 USING PDXEARCH (emb) WITH (metric = '${metric}');

statement ok
DROP INDEX IF EXISTS idx;

endloop

# ============================================
# Parameter: quantization
# ============================================

statement error
CREATE INDEX idx ON t1 USING PDXEARCH (emb) WITH (quantization = 1);
----
Binder Error: PDXearch index 'quantization' must be a string

statement error
CREATE INDEX idx ON t1 USING PDXEARCH (emb) WITH (quantization = 'test');
----
Binder Error: PDXearch index 'quantization' must be one of: 'f32'

foreach quantization f32

statement ok
CREATE INDEX idx ON t1 USING PDXEARCH (emb) WITH (quantization = '${quantization}');

statement ok
DROP INDEX IF EXISTS idx;

endloop

# ============================================
# Parameter: n_probe
# ============================================

statement error
CREATE INDEX idx ON t1 USING PDXEARCH (emb) WITH (n_probe = 'test');
----
Binder Error: PDXearch index 'n_probe' must be an integer

foreach invalid_n_probe -1 -100

statement error
CREATE INDEX idx ON t1 USING PDXEARCH (emb) WITH (n_probe = ${invalid_n_probe});
----
<REGEX>:Binder Error: PDXearch index 'n_probe' must be at least 0, default is .*

endloop

foreach valid_n_probe 0 1 10000

statement ok
CREATE INDEX idx ON t1 USING PDXEARCH (emb) WITH (n_probe = ${valid_n_probe});

statement ok
DROP INDEX IF EXISTS idx;

endloop

# ============================================
# Parameter: normalize
# ============================================

statement error
CREATE INDEX idx ON t1 USING PDXEARCH (emb) WITH (normalize = 'test');
----
Binder Error: PDXearch index 'normalize' must be an integer

foreach invalid_normalize 2 -1

statement error
CREATE INDEX idx ON t1 USING PDXEARCH (emb) WITH (normalize = ${invalid_normalize});
----
<REGEX>:Binder Error: PDXearch index 'normalize' must be 1 \(true\) or 0 \(false\), default is .*

endloop

statement error
CREATE INDEX idx ON t1 USING PDXEARCH (emb) WITH (normalize = 1);
----
Not implemented Error: Normalization is not supported yet.

statement ok
CREATE INDEX idx ON t1 USING PDXEARCH (emb) WITH (normalize = 0);

statement ok
DROP INDEX IF EXISTS idx;

# TODO: Adjust once support for normalization is reimplemented.
# foreach valid_normalize 0 1

# statement ok
# CREATE INDEX idx ON t1 USING PDXEARCH (emb) WITH (normalize = ${valid_normalize});

# statement ok
# DROP INDEX IF EXISTS idx;

endloop

# ============================================
# Parameter: seed
# ============================================

# int32 ranges from -2147483647 to 2147483647.
# Why not -2147483648? Because the number is first parsed without the negation
# sign, so it would be parsed as a positive number, where the max is 2147483647.

foreach invalid_seed 'test' -2147483649 -2147483648 2147483648

statement error
CREATE INDEX idx ON t1 USING PDXEARCH (emb) WITH (seed = ${invalid_seed});
----
Binder Error: PDXearch index 'seed' must be between -2147483647 and 2147483647, inclusive

endloop

foreach valid_seed -2147483647 -1 0 1 2147483647

statement ok
CREATE INDEX idx ON t1 USING PDXEARCH (emb) WITH (seed = ${valid_seed});

statement ok
DROP INDEX IF EXISTS idx;

endloop
