# name: test/sql/search/index_scan_random_embeddings.test
# description: Test index scan recall with randomly generated embeddings across all distance metrics and quantization types.
# group: [search]

require pdxearch

# Variables
test-env INDEX_SEED 0

test-env DIMS 128

test-env NUM_ROWS 10000

test-env LIMIT 50

# Query embedding generated with: SELECT setseed(0.42); SELECT round(random()::FLOAT, 3) FROM range(128);
test-env QUERY_EMB [0.747,0.674,0.604,0.89,0.596,0.516,0.762,0.211,0.743,0.384,0.838,0.441,0.274,0.857,0.243,0.258,0.281,0.689,0.944,0.086,0.091,0.325,0.733,0.837,0.896,0.515,0.721,0.844,0.608,0.186,0.76,0.651,0.048,0.511,0.625,0.315,0.782,0.686,0.868,0.897,0.056,0.956,0.618,0.484,0.674,0.98,0.877,0.551,0.783,0.923,0.732,0.914,0.941,0.645,0.082,0.792,0.686,0.579,0.163,0.37,0.03,0.17,0.69,0.465,0.095,0.001,0.882,0.316,0.653,0.831,0.951,0.176,0.609,0.566,0.555,0.115,0.08,0.572,0.558,0.103,0.202,0.696,0.028,0.362,0.511,0.823,0.244,0.104,0.967,0.334,0.898,0.213,0.145,0.3,0.702,0.063,0.384,0.785,0.71,0.455,0.486,0.926,0.519,0.574,0.923,0.277,0.272,0.194,0.319,0.465,0.07,0.738,0.196,0.824,0.013,0.831,0.162,0.815,0.477,0.082,0.164,0.85,0.864,0.315,0.242,0.021,0.261,0.999]

statement ok
SET late_materialization_max_rows = 0;

# Generate random embeddings.
statement ok
SELECT setseed(0.42);

statement ok
CREATE TABLE t1 AS
SELECT
    id,
    list(value)::FLOAT[${DIMS}] AS emb
FROM (
    SELECT
        CAST(e.i AS INTEGER) AS id,
        d.i AS dim,
        CAST(random() AS FLOAT) AS value
    FROM range(${NUM_ROWS}) e(i), range(${DIMS}) d(i)
) sub
GROUP BY id;

# TODO: Recall doesn't go over 30% when using array_negative_inner_product. 
# @lkuffo: I believe this is something to do with math and random(), but it could be a bug too
foreach metric_name,distance_func l2sq,array_distance cosine,array_cosine_distance

# Compute ground truth (brute-force scan).
statement ok
CREATE OR REPLACE TABLE t_gt AS
SELECT * FROM t1
ORDER BY ${distance_func}(emb, ${QUERY_EMB}::FLOAT[${DIMS}])
LIMIT ${LIMIT};

foreach quantization f32 u8

statement ok
DROP INDEX IF EXISTS t1_idx;

statement ok
CREATE INDEX t1_idx ON t1 USING PDXEARCH (emb) WITH (metric = '${metric_name}', quantization = '${quantization}', seed = ${INDEX_SEED});

# Probe all clusters for maximum recall.
statement ok
SET pdxearch_n_probe = 0;

# Verify the optimizer uses the index scan.
query II
EXPLAIN SELECT * FROM t1
ORDER BY ${distance_func}(emb, ${QUERY_EMB}::FLOAT[${DIMS}])
LIMIT ${LIMIT};
----
physical_plan	<REGEX>:.*PDXEARCH_INDEX_SCAN.*

statement ok
CREATE OR REPLACE TABLE t_idx_res AS
SELECT * FROM t1
ORDER BY ${distance_func}(emb, ${QUERY_EMB}::FLOAT[${DIMS}])
LIMIT ${LIMIT};

# Verify recall >= 90%.
query I
SELECT CAST(COUNT(*) AS FLOAT) / ${LIMIT} >= 0.95
FROM t_gt JOIN t_idx_res USING (id);
----
true

endloop

endloop
